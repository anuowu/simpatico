<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>Simpatico: 2.11.1 Multi-system simulations: mcSim and mdSim</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Simpatico
   &#160;<span id="projectnumber">v1.10</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="index.html">Simpatico - Simulation Package for Polymer and Molecular Liquids</a></li><li class="navelem"><a class="el" href="user_page.html">2 User Guide</a></li><li class="navelem"><a class="el" href="user_multi_page.html">2.11 Multi-System Simulations</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">2.11.1 Multi-system simulations: mcSim and mdSim </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="el" href="user_multi_DdMd_page.html">2.11.2 Multi-system simulations: ddSim</a> (Next) &#160; &#160; &#160; &#160; <br />
</p>
<p>MPI-enabled versions of mcSim and mdSim allow different processors within an MPI communicator to simulate different systems, with one system per processor. The names of MPI-enabled versions of these programs include a suffix _m (for MPI), and are called mcSim_m and mdSim_m if no other optional features are enabled.</p>
<p>The multi-processor versions of mcSim or mdSim can be invoked in either "independent" mode or "perturbation" mode. In "independent" mode, these programs simply run a set of completely independent simulations, with completely separate input files for every processor. In "perturbation" mode, these programs use different input configuration files for different processors but use a single parameter and command file to control all processors. In perturbation mode, the parameter file contains instructions for assigning a sequence of slightly different set of parameter values to different processors. Both modes are described in more detail below.</p>
<p>In either mode, conventions for paths to input and ouput file names are different for multi-system simulations than those for single-system simulations. Each processor in an MPI job is assigned a integer "rank" in the range n = 0, ..., np-1, where np is the total number of processors. In a multiprocessor mcSim or mdSim simulation, all or many of the files associated with a processor with rank "n" are placed in a numbered subdirectory of the working directory named "n/", e.g., in a directory named "3/" for the processor with MPI rank 3.</p>
<h1><a class="anchor" id="user_multi_independent_sec"></a>
Independent Simulation Mode</h1>
<p>To use a parallel version of mcSim or mdSim to run n completely independent simulations, one simply enters the name of the executable from, such as "mcSim_m" or "mdSim_m", from a directory that contains a set of numbered directories named 0/, 1/, 2/, .. n-1/ associated with different processors. In this mode of operation, every processor reads a completely different set of param, command and configuration input files, all of which are located in a numbered directory associated with that processor. This file convention is enforced by prepending the name of the numbered directory to the names of all input and output files that are opened by the progam, e.g., by prepending a prefix "3/" to the names of any files that are open by the processor with MPI rank 3. This manipulation of file names is done by the FileMaster class.</p>
<p>In independent mode, the paths to the parameter and command file for each system are files in the associated numbered directory with base names specified as arguments to the -p and -c command line options. Paths to other input files (such as the input configuration file) and output files (such as those created by analyzer classes) are also defined relative to the relevant numbered directory. All such path names are obtained obtained by adding a the prefix "n/" for processor n before the parameter and command file names, and before the inputPrefix or outputPrefix strings specified in the parameter file.</p>
<p>As an example, consider a set of MC simulations on 3 processors. Assume that the param file for each processor sets the inputPrefix string to "in/" and the outputPrefix to "out/". Also assume that each command file contains a command "READ_CONFIG config" that read the initial configuration from a file named "config" in the appropriate data input directory. Such a simulation can be run by entering </p><div class="fragment"><div class="line">mpirun -np 3 mSim_m -p param -c commands</div></div><!-- fragment --><p> from root of a directory tree with a structure </p><div class="fragment"><div class="line">0/</div><div class="line">  param</div><div class="line">  commands</div><div class="line">  in/</div><div class="line">    config</div><div class="line">  out/</div><div class="line">1/</div><div class="line">  param</div><div class="line">  commands</div><div class="line">  in/</div><div class="line">    config</div><div class="line">  out/</div><div class="line">2/ </div><div class="line">  param</div><div class="line">  commands</div><div class="line">  in/</div><div class="line">    config</div><div class="line">  out/</div></div><!-- fragment --><p> The command "READ_CONFIG config" in each command file will cause each processor to read the input configuration file "in/config" in the appropriate numbered directory for that processor. When the simulation is run, all configuration and data analysis output files for each processor will be written to the "out" directory of the corresponding numbered directory.</p>
<h1><a class="anchor" id="user_multi_replicated_sec"></a>
Replicated Simulations</h1>
<p>To invoke an parallel version of mcSim or mdSim in "perturbation" mode, simply invoke the program with the "-f" option. This command line option only functions in versions of the code that were compiled with MPI enabled. In this mode, simulations carried out on different processors are controlled by a single parameter file and a single command file, but different parameter values are assigned to different processors. This mode of operation is required for either free energy perturbation or replica exchange simulations.</p>
<p>For example, to run a MC program in this mode on 3 processors, one might thus enter </p><div class="fragment"><div class="line">mpirun -np 2 mSim_m -f -p param -c commands</div></div><!-- fragment --><p> from the root directory of a directory tree with a structure </p><div class="fragment"><div class="line">param</div><div class="line">commands</div><div class="line">0/</div><div class="line">  in/</div><div class="line">    config</div><div class="line">  out/</div><div class="line">1/</div><div class="line">  in/</div><div class="line">    config</div><div class="line">  out/</div><div class="line">2/ </div><div class="line">  in/</div><div class="line">    config</div><div class="line">  out/</div></div><!-- fragment --><p> In this case, a single parameter file named "param" and command file named "commands" is read from the common root directory, and used to control the simulations on all three processors. In this mode, separate input configuration files are read from the in/ subdirectory of the associated numbered subdirectory, and output files produced by each processor are written to files within the associated numbered directory.</p>
<p>The method by which a single parameter file is used to set different parameter values on different processors involves the use of a <a class="el" href="classMcMd_1_1Perturbation.html" title="Model of parameter dependence in a free energy perturbation theory. ">Perturbation</a> class, and is discussed below.</p>
<h1><a class="anchor" id="user_multi_perturb_sec"></a>
Perturbation Classes</h1>
<p>In perturbation mode, the master processor reads a parameter file, and broadcasts the contents of that file to all the other processors. This establishes a baseline set of parameters that are the same on all processors. The parameter file used in such simulations must also, however, contain a polymorphic block associated with a subclass of the <a class="el" href="classMcMd_1_1Perturbation.html" title="Model of parameter dependence in a free energy perturbation theory. ">McMd::Perturbation</a> abstract base class. The "Pertubation" object must define how a sequence of different parameter values should be assigned on different processors. The block appears at the end of the block associated with the <a class="el" href="classMcMd_1_1McSystem.html" title="A System for use in a Markov chain Monte Carlo simulation. ">McSystem</a> or <a class="el" href="classMcMd_1_1MdSystem.html" title="A System for Molecular Dynamics simulation. ">MdSystem</a>.</p>
<p>Each subclass of <a class="el" href="classMcMd_1_1Perturbation.html" title="Model of parameter dependence in a free energy perturbation theory. ">Perturbation</a> defines how a sequence of slightly different sets of different physical parameters should be assigned to different processors in an MPI communicator, using the parameters set in the remainder of the parameter file as a common starting point. A subclass of <a class="el" href="classMcMd_1_1Perturbation.html" title="Model of parameter dependence in a free energy perturbation theory. ">Perturbation</a> may assign different values to different processors for any parameters that effect the statistical weight for a microstate. To do so, it may modify values of either macroscopic state variables such as temperature or pressure, or parameters in the potential energy. The default implementation of the parameter file block associated with a <a class="el" href="classMcMd_1_1Perturbation.html" title="Model of parameter dependence in a free energy perturbation theory. ">Perturbation</a> reads in an array of values for some parameter, with a different value is assigned to each processor. The implementation of each subclass of <a class="el" href="classMcMd_1_1Perturbation.html" title="Model of parameter dependence in a free energy perturbation theory. ">Perturbation</a> must define how these input parameters should be used to reset values of one more more of the physical parameters of a simulation. Different parameters are set on different processors by first setting the parameters on all processors to common baseline values, which are determined by the value given for quantities such as the potential energy parameters and temperature in the rest of the parameter block, and then calling a virtual method of the <a class="el" href="classMcMd_1_1Perturbation.html" title="Model of parameter dependence in a free energy perturbation theory. ">Perturbation</a> object to reset specific parameters to different values on different processors.</p>
<p>As a simple example of this, <a class="el" href="classMcMd_1_1McEnergyPerturbation.html" title="A Perturbation with a variable inverse temperature. ">McEnergyPerturbation</a> is a subclass of <a class="el" href="classMcMd_1_1Perturbation.html" title="Model of parameter dependence in a free energy perturbation theory. ">Perturbation</a> that sets every processor in an MC simulation to a different temperature, or inverse temperature beta, while using the same values for all potential energy parameters on all processors. The required values of inverse temperature for different processors are input as an array in the parameter file block that is read by <a class="el" href="classUtil_1_1ParamComposite.html#a6fc094b057fd9a21641b089f6f063b39" title="Read the parameter file block. ">McEnergyPerturbation::readParam()</a>, listed in order of the MPI ranks of corresponding processors. The contents of this entire array is broadcast to all processors, and each processor then resets its temperature to a value obtained from the appropriate elements of the array (i.e., processor 4 resets its temperature to the value corresponding to element 4 in this array).</p>
<h1><a class="anchor" id="user_multi_exchange_sec"></a>
Replica Exchange</h1>
<p>Simpatico provides a replica exchange algorithm, which can be used in multiprocessor MC simulations with any associated Perburbation. The replica exchange algorithm is implemented by the class <a class="el" href="classMcMd_1_1ReplicaMove.html" title="Replica exchange Monte Carlo move using Gibbs sampling. ">McMd::ReplicaMove</a>, which implements a Monte Carlo move that exchanges configurations between processors with neighboring MPI ranks. Please see the documentation of the "ReplicaMove" class for further information.</p>
<p>In the parameter file format for an MC simulation in perturbation mode, the block associated with the <a class="el" href="classMcMd_1_1Perturbation.html" title="Model of parameter dependence in a free energy perturbation theory. ">Perturbation</a> must be followed by a line containing a boolean parameter "hasReplicaMove", which may take on values 1 (true) or 0 (false). This parameter is required only in multi-system replicated simulations. If "hasReplicaMove" is true (1), it must be followed by a parameter block associated with the <a class="el" href="classMcMd_1_1ReplicaMove.html" title="Replica exchange Monte Carlo move using Gibbs sampling. ">ReplicaMove</a> class. The <a class="el" href="classMcMd_1_1ReplicaMove.html" title="Replica exchange Monte Carlo move using Gibbs sampling. ">ReplicaMove</a> parameter file block a single "interval" parameter that specifies the interval (in MC steps) between subsequent attempted MC moves.</p>
<h1><a class="anchor" id="user_multi_example_sec"></a>
Example Parameter File</h1>
<p>Show below is an example of a parameter file for a replicated mcSim simulation of a polymer blend, which is simulated on three processors. This example uses the <a class="el" href="classMcMd_1_1McPairPerturbation.html" title="A Perturbation in the pair interaction epsilon(0,1) for any pair potential supporting setEpsilon()...">McPairPerturbation</a> subclass of <a class="el" href="classMcMd_1_1Perturbation.html" title="Model of parameter dependence in a free energy perturbation theory. ">Perturbation</a> to define a sequence of systems with different values of the epsilon parameter for interactions between A and B atoms, and uses a replica exchange move. The parameter block associated with the <a class="el" href="classMcMd_1_1McPairPerturbation.html" title="A Perturbation in the pair interaction epsilon(0,1) for any pair potential supporting setEpsilon()...">McPairPerturbation</a> and <a class="el" href="classMcMd_1_1ReplicaMove.html" title="Replica exchange Monte Carlo move using Gibbs sampling. ">ReplicaMove</a> appear at the end of the <a class="el" href="classMcMd_1_1McSystem.html" title="A System for use in a Markov chain Monte Carlo simulation. ">McSystem</a> block.</p>
<div class="fragment"><div class="line">McSimulation{</div><div class="line">  FileMaster{</div><div class="line">    commandFileName                paramfile</div><div class="line">    inputPrefix                          in/</div><div class="line">    outputPrefix                        out/</div><div class="line">  }</div><div class="line">  nAtomType                              2</div><div class="line">  nBondType                              1</div><div class="line">  atomTypes                    A       1.0</div><div class="line">                               B       1.0</div><div class="line">  maskedPairPolicy                MaskBonded</div><div class="line">  SpeciesManager{</div><div class="line"></div><div class="line">    Homopolymer{</div><div class="line">      moleculeCapacity                      50</div><div class="line">      nAtom                                  8</div><div class="line">      atomType                               0</div><div class="line">      bondType                               0</div><div class="line">    }</div><div class="line"></div><div class="line">    Homopolymer{</div><div class="line">      moleculeCapacity                       50</div><div class="line">      nAtom                                   8</div><div class="line">      atomType                                1</div><div class="line">      bondType                                0</div><div class="line">    }</div><div class="line"></div><div class="line">  }</div><div class="line">  Random{</div><div class="line">    seed                           13451892</div><div class="line">  }</div><div class="line">  McSystem{</div><div class="line">    pairStyle                        LJPair</div><div class="line">    bondStyle                  HarmonicBond</div><div class="line">    McPairPotential{</div><div class="line">      epsilon               1.000000000000e+00  1.000000000000e+00</div><div class="line">                            1.000000000000e+00  1.000000000000e+00</div><div class="line">      sigma                 1.000000000000e+00  1.000000000000e+00</div><div class="line">                            1.000000000000e+00  1.000000000000e+00</div><div class="line">      cutoff                1.122460000000e+00  1.122460000000e+00</div><div class="line">                            1.122460000000e+00  1.122460000000e+00</div><div class="line">      maxBoundary             cubic  10.5 </div><div class="line">    }</div><div class="line">    BondPotential{</div><div class="line">      kappa                 2.000000000000e+03</div><div class="line">      length                1.000000000000e+00</div><div class="line">    }</div><div class="line">    EnergyEnsemble{</div><div class="line">      type                  isothermal</div><div class="line">      temperature           1.000000000000e+00</div><div class="line">    }</div><div class="line">    BoundaryEnsemble{</div><div class="line">      type                  rigid</div><div class="line">    }</div><div class="line">    McPairPerturbation{</div><div class="line">      parameters            1.000000000000e+00</div><div class="line">                            1.150000000000e+00</div><div class="line">                            1.300000000000e+00</div><div class="line">    }</div><div class="line">    hasReplicaMove                             1</div><div class="line">    ReplicaMove{</div><div class="line">      interval                             2000</div><div class="line">    }</div><div class="line">  }</div><div class="line">  McMoveManager{</div><div class="line"></div><div class="line">    HybridMdMove{</div><div class="line">      probability           0.010000000000e+00</div><div class="line">      nStep                                100</div><div class="line">      MdSystem{</div><div class="line">        MdPairPotential{</div><div class="line">          maxBoundary             cubic  10.5 </div><div class="line">          PairList{</div><div class="line">            atomCapacity                        1000</div><div class="line">            pairCapacity                       10000</div><div class="line">            skin                  3.000000000000e-01</div><div class="line">          }</div><div class="line">        }</div><div class="line">        NveVvIntegrator{</div><div class="line">          dt                    5.000000000000e-03</div><div class="line">        }</div><div class="line">      }</div><div class="line">    }</div><div class="line"></div><div class="line">    CfbReptationMove{</div><div class="line">      probability           0.990000000000e+00</div><div class="line">      speciesId                              0</div><div class="line">      nTrial                                20</div><div class="line">      hasAutoCorr 0</div><div class="line">    }</div><div class="line"></div><div class="line">  }</div><div class="line">  AnalyzerManager{</div><div class="line">    baseInterval                        1000</div><div class="line"></div><div class="line">    LogProgress{</div><div class="line">      interval                         20000</div><div class="line">    }</div><div class="line"></div><div class="line">    McWriteRestart{</div><div class="line">      interval                          1000</div><div class="line">      outputFileName                 restart</div><div class="line">    }</div><div class="line"></div><div class="line">    McEnergyAverage{</div><div class="line">      interval                          1000</div><div class="line">      outputFileName               energyAve</div><div class="line">      nSamplePerBlock                     10</div><div class="line">    }</div><div class="line"></div><div class="line">    McPairEnergyAverage{</div><div class="line">      interval                          1000</div><div class="line">      outputFileName              pairEnergy</div><div class="line">      nSamplePerBlock                     10</div><div class="line">      selector                           inter  -1  -1</div><div class="line">    }</div><div class="line">   </div><div class="line">  }</div><div class="line">}</div></div><!-- fragment --><h1><a class="anchor" id="user_multi_restart_sec"></a>
Restarting multi-system simulations</h1>
<p>Is is also possible to restart multi-processor mcSim and mdSim simulations. During the original simulation, the frequency with which restart files should be written and the base name for these files is specified in the parameter file, exactly as for single-system simulations. In multi-system simulations, each processor writes a separate restart file, for both independent and replicate simulations. The restart file for each processor is placed in the associated numbered directory. For example, if the saveFileName parameter in the original parameter file is "restart", the restart file for processor 2 would be repeatedly written to the file 2/restart.rst.</p>
<p>Different conventions are used for the placement of restart command files for "independent" and "replicated" simulations. Independent simulations use a separate restart command file for each processor, each of which is placed in the same numbered directory as the associated restart file. Replicated simulations use a single restart command file, which must be placed in the same directory as the single restart file, and the single parameter file and command file for the original simulation. In either case, the base name of the restart command file is passed as command line parameter of the -c option.</p>
<p>The command to restart a multi-processor simulation is similar to that for a single-processor simulation. The command to restart a 3 processor mcSim simulation of either independent or replicated systems, using the mcSim_m executable and the mpirun command to launch an MPI program, using a restart file named "restart" and a command file named "restart.cmd", is: </p><div class="fragment"><div class="line">mpirun -np 3 mcSim_m -e -r restart -c restart.cmd</div></div><!-- fragment --><p> Information about whether the original simulations were independent or replicated is stored within all restart files, and does not need to be be specified by a command line option when the simulation is restarted. Invoking an mcSim or mdSim executable with both the "-r" and "-f" options is thus illegal, and will cause execution to halt with an error message.</p>
<p><br />
 <a class="el" href="user_multi_page.html">2.11 Multi-System Simulations</a> (Up) &#160; &#160; &#160; &#160; <a class="el" href="user_multi_DdMd_page.html">2.11.2 Multi-system simulations: ddSim</a> (Next) &#160; &#160; &#160; &#160; </p>
</div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.3-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Fri Oct 6 2017 17:05:31 for Simpatico by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
